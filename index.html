<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Great Filter Location Probability Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .control-group h3 {
            margin-top: 0;
            color: #87ceeb;
            border-bottom: 2px solid rgba(135, 206, 235, 0.3);
            padding-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            margin-bottom: 15px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 14px;
        }
        
        input[type="range"] {
            margin-bottom: 0px;
        }

        .control-group input,
        .control-group select,
        .control-group button {
            padding-left: 10px;
            padding-right: 10px;
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: linear-gradient(45deg, #ee5a24, #ff6b6b);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px; /* Taller charts */
        }
        
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .step-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 10px;
            color: #333;
        }
        
        .evidence-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            border-left: 4px solid #87ceeb;
        }
        
        .prob-change {
            font-weight: bold;
            color: #90EE90;
        }
        
        .prob-change.negative {
            color: #FFB6C1;
        }
        
        .analysis-table {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .analysis-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .analysis-table th, .analysis-table td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        
        .analysis-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
        
        .existential-risk {
            background: rgba(255, 100, 100, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ff6464;
            font-size: 16px;
            font-weight: bold;
        }
        
        .good-news {
            background: rgba(100, 255, 100, 0.2);
            border-left-color: #64ff64;
        }

        .conditional-controls {
            border: 2px solid rgba(135, 206, 235, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 5px;
            margin-bottom: 15px;
            background: rgba(135, 206, 235, 0.05);
        }

        .conditional-controls h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #87ceeb;
            font-size: 14px;
        }

        .footer-link {
            text-align: right;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .footer-link a {
            color: #87ceeb;   /* matches your accent */
            text-decoration: none;
            font-weight: bold;
        }

        .footer-link a:hover {
            text-decoration: underline;
        }

        /* Responsive layout for small screens */
        @media (max-width: 768px) {
            .chart-row {
                grid-template-columns: 1fr; /* stack charts vertically */
            }

            .analysis-table {
                overflow-x: auto; /* allow horizontal scroll */
            }

            .analysis-table table {
                min-width: 600px; /* prevent extreme shrinking */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧬 Great Filter Location Probability Simulator</h1>
        <div class="subtitle">
            Two-Layer Model: Survival Probabilities → Filter Location Probabilities<br>
            Key Question: Where is the Great Filter most likely located?
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>Setup Parameters</h3>
                <label for="numSteps">Number of Hard Evolutionary Steps:</label>
                <input type="number" id="numSteps" value="12" min="3" max="15">
                
                <label for="priorShape">Prior Survival Distribution:</label>
                <select id="priorShape">
                    <option value="uniform" selected>Uniform (All steps equally hard)</option>
                    <option value="early-hard">Early Hard (Biology difficult)</option>
                    <option value="late-hard">Late Hard (Technology difficult)</option>
                    <option value="middle-hard">Middle Hard (Complexity crisis)</option>
                </select>
                
                <label for="baseProbability">Base Step Survival Probability:</label>
                <input type="range" id="baseProbability" min="0.01" max="1" value="0.1" step="0.01">
                <span id="baseProbValue">10%</span>
                
                <button onclick="initializeModel()">Initialize Model</button>
            </div>
            
            <div class="control-group">
                <h3>New Evidence of Alien Life</h3>
                <label for="evidenceStep">Evidence at Step:</label>
                <input type="number" id="evidenceStep" min="1" max="15" value="3">
                
                <label for="stellarSystem">Evidence Location:</label>
                <select id="stellarSystem" onchange="toggleSolarSystemControls()">
                    <option value="other" selected>Other Stellar System</option>
                    <option value="solar">Solar System (e.g., Mars, Europa)</option>
                </select>

                <div id="solarSystemControls" class="conditional-controls" style="display: none;">
                    <h4>Solar System Evidence Additional Control</h4>
                    <label for="updateStrengthFirst">Update Strength (First Step):</label>
                    <p style="font-size: 12px; margin: 5px 0;">Our solar system may be more biophilic than the first step is easier.</p>
                    <span id="updateValueFirst">1.5x</span>
                    <input type="range" id="updateStrengthFirst" min="1" max="10" value="1.5" step="0.1">
                </div>

                <label for="lifeStatus">Life Status:</label>
                <select id="lifeStatus" onchange="toggleExtinctControls()">
                    <option value="extant" selected>Extant (Still Alive)</option>
                    <option value="extinct">Extinct (Fossil)</option>
                </select>
                
                <label for="updateStrengthPrior">Update Strength (Prior & Current Steps):</label>
                <p style="font-size: 12px; margin: 5px 0;">How much more probable is for the great filter to be located in the present and prior steps?</p>
                <span id="updateValuePrior">2.0x</span>
                <input type="range" id="updateStrengthPrior" min="1" max="10" value="2" step="0.1">
                
                <div id="extinctControls" class="conditional-controls">
                    <h4>Extinct Life Additional Controls</h4>
                    <label for="updateStrengthNext">Update Strength (Next Step):</label>
                    <p style="font-size: 12px; margin: 5px 0;">More probable for the great filter to be on the next step, as life went extinct on the present step.</p>
                    <span id="updateValueNext">3.0x</span>
                    <input type="range" id="updateStrengthNext" min="1" max="10" value="3" step="0.1">
                </div>
                
                <button onclick="addEvidence()">Add Evidence</button>
                <button onclick="resetModel()">Reset to Prior</button>
            </div>
            
            <div class="control-group">
                <h3>Humanity's Position</h3>
                <label for="humanityStep">Humanity is currently at step:</label>
                <input type="number" id="humanityStep" min="1" max="15" value="9">
                <p style="font-size: 12px; opacity: 0.8;">
                    This affects the "behind us vs ahead of us" calculation for existential risk assessment.
                </p>
                
                <div id="riskAssessment" class="existential-risk">
                    <div id="riskText">Initialize model to see risk assessment</div>
                </div>
            </div>
        </div>
        
        <div id="evidenceInfo" class="evidence-info" style="display: none;">
            <h3>Evidence Impact Analysis</h3>
            <div id="evidenceDetails"></div>
        </div>
        
        <div class="chart-row">
            <div class="chart-container">
                <canvas id="survivalChart"></canvas>
                <div class="step-labels" id="stepLabels1"></div>
            </div>
            <div class="chart-container">
                <canvas id="filterLocationChart"></canvas>
                <div class="step-labels" id="stepLabels2"></div>
            </div>
            <div class="chart-container">
                <canvas id="cumulativeChart"></canvas>
                <div class="step-labels" id="stepLabels3"></div>
            </div>
        </div>
        
        <div class="analysis-table">
            <h3>Detailed Analysis</h3>
            <table id="analysisTable">
                <thead>
                    <tr>
                        <th>Step</th>
                        <th>Name</th>
                        <th>Survival Prob</th>
                        <th>Filter Location Prob</th>
                        <th>Cumulative Reach Prob</th>
                        <th>Difficulty Factor</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <div class="footer-link">
        <a href="https://github.com/ferdesmello/the-great-filter-toy-model" target="_blank">
            Source code and more
        </a>
    </div>

    <script>
        let survivalChart, filterLocationChart, cumulativeChart;
        let numSteps = 12;
        let priorSurvivalProbs = [];
        let currentSurvivalProbs = [];
        let priorFilterLocationProbs = [];
        let currentFilterLocationProbs = [];
        let baselineProbAhead = null;
        
        const stepNames = [
            'Planetary Habitability',
            'Abiogenesis',
            'Simple Cells',
            'Oxygenic Photosynthesis',
            'Complex Cells',
            'Sexual Reproduction',
            'Multicellarity',
            'Intelligence',
            'Technology',
            'Space Travel',
            'Interstellar Travel',
            'Galactic Expansion',
            'Post-Biological',
            'Cosmic Transcendence',
            'Ultimate Understanding'
        ];

        //-------------------------------------------------------------------------------
        function toggleExtinctControls() {
            const lifeStatus = document.getElementById('lifeStatus').value;
            const extinctControls = document.getElementById('extinctControls');
            extinctControls.style.display = lifeStatus === 'extinct' ? 'block' : 'none';
        }

        // Event listeners
        document.getElementById('baseProbability').addEventListener('input', function(e) {
            const prob = parseFloat(e.target.value);
            document.getElementById('baseProbValue').textContent = (prob * 100).toFixed(1) + '%';
        });

        // New Event listener for Solar System First Step slider
        document.getElementById('updateStrengthFirst').addEventListener('input', function(e) {
            const strength = parseFloat(e.target.value);
            document.getElementById('updateValueFirst').textContent = strength.toFixed(1) + 'x';
        });

        // New Toggle function for Solar System controls
        function toggleSolarSystemControls() {
            const stellarSystem = document.getElementById('stellarSystem').value;
            const solarSystemControls = document.getElementById('solarSystemControls');
            solarSystemControls.style.display = stellarSystem === 'solar' ? 'block' : 'none';
        }

        // Update the existing toggleExtinctControls to also call the new one on initial load
        function toggleExtinctControls() {
            const lifeStatus = document.getElementById('lifeStatus').value;
            const extinctControls = document.getElementById('extinctControls');
            extinctControls.style.display = lifeStatus === 'extinct' ? 'block' : 'none';
            
            // Call the new toggle function here to ensure the state is correct on initialization
            toggleSolarSystemControls(); 
        }

        document.getElementById('updateStrengthPrior').addEventListener('input', function(e) {
            const strength = parseFloat(e.target.value);
            document.getElementById('updateValuePrior').textContent = strength.toFixed(1) + 'x';
        });

        document.getElementById('updateStrengthNext').addEventListener('input', function(e) {
            const strength = parseFloat(e.target.value);
            document.getElementById('updateValueNext').textContent = strength.toFixed(1) + 'x';
        });

        //-------------------------------------------------------------------------------
        function generateSurvivalProbabilities(shape, steps, baseProb) {
            let probs = new Array(steps).fill(baseProb);
            
            switch(shape) {
                case 'uniform':
                    break;
                case 'early-hard':
                    for(let i = 0; i < steps; i++) {
                        const factor = Math.exp(-i * 0.4);
                        probs[i] = Math.max(0.01, Math.min(1, baseProb + (1 - baseProb) * (1 - factor)));
                    }
                    break;
                case 'late-hard':
                    for(let i = 0; i < steps; i++) {
                        const factor = Math.exp((i - steps) * 0.4);
                        probs[i] = Math.max(0.01, Math.min(1, baseProb * (1.0 + factor)));
                    }
                    break;
                case 'middle-hard':
                    for(let i = 0; i < steps; i++) {
                        const center = steps / 2;
                        const distance = Math.abs(i - center);
                        const factor = Math.exp(-distance * 0.6);
                        probs[i] = Math.max(0.01, Math.min(1, baseProb * factor + 0.1));
                    }
                    break;
            }
            return probs;
        }

        //-------------------------------------------------------------------------------
        function calculateFilterLocationProbabilities(survivalProbs) {
            const difficultyFactors = survivalProbs.map(p => 1 - p);
            const totalDifficulty = difficultyFactors.reduce((sum, d) => sum + d, 0);
            
            if (totalDifficulty === 0) {
                return new Array(survivalProbs.length).fill(1 / survivalProbs.length);
            }
            
            return difficultyFactors.map(d => d / totalDifficulty);
        }

        //-------------------------------------------------------------------------------
        function calculateCumulativeProbabilities(survivalProbs) {
            let cumulative = [];
            let product = 1.0;
            
            for(let i = 0; i < survivalProbs.length; i++) {
                product *= survivalProbs[i];
                cumulative.push(product);
            }
            return cumulative;
        }

        //-------------------------------------------------------------------------------
        function initializeModel() {
            numSteps = parseInt(document.getElementById('numSteps').value);
            const shape = document.getElementById('priorShape').value;
            const baseProb = parseFloat(document.getElementById('baseProbability').value);

            document.getElementById('evidenceStep').max = numSteps;
            document.getElementById('humanityStep').max = numSteps;
            
            priorSurvivalProbs = generateSurvivalProbabilities(shape, numSteps, baseProb);
            currentSurvivalProbs = [...priorSurvivalProbs];
            
            priorFilterLocationProbs = calculateFilterLocationProbabilities(priorSurvivalProbs);
            currentFilterLocationProbs = [...priorFilterLocationProbs];

            const humanityStep = parseInt(document.getElementById('humanityStep').value) - 1;
            let probAhead = 0;
            for (let i = 0; i < numSteps; i++) {
                if (i > humanityStep) probAhead += currentFilterLocationProbs[i];
            }
            baselineProbAhead = probAhead;
            
            updateAllCharts();
            updateTable();
            updateRiskAssessment();
            hideEvidenceInfo();
            toggleExtinctControls();
        }

        //-------------------------------------------------------------------------------
        function addEvidence() {
            const evidenceStep = parseInt(document.getElementById('evidenceStep').value) - 1; // 0-indexed step number
            const lifeStatus = document.getElementById('lifeStatus').value;
            const stellarSystem = document.getElementById('stellarSystem').value;
            const updateStrengthPrior = parseFloat(document.getElementById('updateStrengthPrior').value);
            const updateStrengthNext = parseFloat(document.getElementById('updateStrengthNext').value);
            const updateStrengthFirst = parseFloat(document.getElementById('updateStrengthFirst').value);

            if (evidenceStep >= numSteps || evidenceStep < 0) {
                alert('Evidence step must be between 1 and ' + numSteps);
                return;
            }

            const oldSurvivalProbs = [...currentSurvivalProbs];
            const oldFilterLocationProbs = [...currentFilterLocationProbs];

            // --- APPLY UPDATES BASED ON 4 CASES ---

            if (stellarSystem === 'solar') {
                // A. Solar System Bias: Apply factor to Step 1 (index 0).
                if (evidenceStep >= 0) {
                    currentSurvivalProbs[0] = Math.min(1, currentSurvivalProbs[0] * updateStrengthFirst);
                }

                // B. General Evidence Factor: Apply factor starting from Step 2 (index 1) up to evidenceStep.
                for(let i = 1; i < numSteps; i++) {
                    if (i <= evidenceStep) {
                        currentSurvivalProbs[i] = Math.min(1, currentSurvivalProbs[i] * updateStrengthPrior);
                    }
                }

                // C. Extinction Factor: Apply to the step AFTER evidenceStep, if it exists.
                if (lifeStatus === 'extinct') {
                    // **CRITICAL FIX:** Check if the next step exists before trying to access it.
                    if (evidenceStep + 1 < numSteps) { 
                        currentSurvivalProbs[evidenceStep + 1] = Math.min(1, currentSurvivalProbs[evidenceStep + 1] / updateStrengthNext);
                    }
                }
            
            } else { // stellarSystem === 'other' (Original Logic)

                // A. General Evidence Factor: Apply factor starting from Step 1 (index 0) up to evidenceStep.
                for(let i = 0; i < numSteps; i++) {
                    if (i <= evidenceStep) {
                        currentSurvivalProbs[i] = Math.min(1, currentSurvivalProbs[i] * updateStrengthPrior);
                    }
                }

                // B. Extinction Factor: Apply to the step AFTER evidenceStep, if it exists.
                if (lifeStatus === 'extinct') {
                    // **CRITICAL FIX:** Check if the next step exists before trying to access it.
                    if (evidenceStep + 1 < numSteps) { 
                        currentSurvivalProbs[evidenceStep + 1] = Math.min(1, currentSurvivalProbs[evidenceStep + 1] / updateStrengthNext);
                    }
                }
            }
         
            currentFilterLocationProbs = calculateFilterLocationProbabilities(currentSurvivalProbs);

            showEvidenceInfo(evidenceStep, lifeStatus, updateStrengthPrior, updateStrengthNext, updateStrengthFirst, oldSurvivalProbs, oldFilterLocationProbs, stellarSystem);
            updateAllCharts();
            updateTable();
            updateRiskAssessment();
        }

        //-------------------------------------------------------------------------------
        // Add updateStrengthFirst and stellarSystem to the signature
        function showEvidenceInfo(step, status, strengthPrior, strengthNext, strengthFirst, oldSurvival, oldFilterLocation, stellarSystem) { 
            const evidenceInfo = document.getElementById('evidenceInfo');
            const evidenceDetails = document.getElementById('evidenceDetails');
            
            const stepName = stepNames[step];
            const statusText = status === 'extinct' ? 'Extinct (Fossil)' : 'Extant (Still Alive)';
            const systemText = stellarSystem === 'solar' ? 'Solar System (Local Bias)' : 'Other Stellar System (General)';

            let impactText = `<p><strong>Source:</strong> ${systemText}</p>`;
            impactText += `<p><strong>Evidence:</strong> ${statusText} life found at step ${step + 1} (${stepName})</p>`;
            
            // Display the new Solar System factor if applicable
            if (stellarSystem === 'solar' && step >= 0) { 
                impactText += `<p><strong>Update Strength (First Step Only):</strong> ${strengthFirst.toFixed(2)}x</p>`; 
            }

            impactText += `<p><strong>Update Strength (Prior & Current Steps):</strong> ${strengthPrior.toFixed(2)}x</p>`;
            if (status === 'extinct') {
                impactText += `<p><strong>Update Strength (Next Step):</strong> ${strengthNext.toFixed(2)}x</p>`;
            }

            // Filter Location Probability Changes
            impactText += '<p><strong>Filter Location Probability Changes:</strong></p><ul>';
            for (let i = 0; i < numSteps; i++) {
                const change = currentFilterLocationProbs[i] - oldFilterLocation[i];
                if (Math.abs(change) > 0.001) {
                    const changePercent = (change * 100).toFixed(2);
                    const changeClass = change > 0 ? 'prob-change' : 'prob-change negative';
                    const sign = change > 0 ? '+' : '';
                    impactText += `<li>Step ${i + 1} (${stepNames[i]}): <span class="${changeClass}">${sign}${changePercent}%</span></li>`;
                }
            }
            impactText += '</ul>';
            
            // Survival Probability Changes
            impactText += '<p><strong>Survival Probability Changes:</strong></p><ul>';
            for (let i = 0; i < numSteps; i++) {
                const change = currentSurvivalProbs[i] - oldSurvival[i];
                if (Math.abs(change) > 0.001) {
                    const changePercent = (change * 100).toFixed(2);
                    const changeClass = change > 0 ? 'prob-change' : 'prob-change negative';
                    const sign = change > 0 ? '+' : '';
                    impactText += `<li>Step ${i + 1} (${stepNames[i]}): <span class="${changeClass}">${sign}${changePercent}%</span></li>`;
                }
            }
            impactText += '</ul>';
            
            evidenceDetails.innerHTML = impactText;
            evidenceInfo.style.display = 'block';
        }

        //-------------------------------------------------------------------------------
        function updateRiskAssessment() {
            const humanityStep = parseInt(document.getElementById('humanityStep').value) - 1;
            const riskDiv = document.getElementById('riskAssessment');
            const riskText = document.getElementById('riskText');

            let probBehind = 0, probAhead = 0;
            for (let i = 0; i < numSteps; i++) {
                if (i <= humanityStep) probBehind += currentFilterLocationProbs[i];
                else probAhead += currentFilterLocationProbs[i];
            }

            const riskPercent = (probAhead * 100).toFixed(2);
            const safePercent = (probBehind * 100).toFixed(2);

            let trend = null;
            if (baselineProbAhead !== null) {
                if (probAhead > baselineProbAhead) trend = 'worse';
                else if (probAhead < baselineProbAhead) trend = 'better';
            }

            if (trend === 'worse') {
                riskDiv.className = 'existential-risk';
                riskText.innerHTML = `
                    <strong>⚠️ HIGHER EXISTENTIAL RISK</strong><br>
                    ${riskPercent}% chance the Great Filter is ahead of humanity<br>
                    ${safePercent}% chance it's behind us
                `;
            } else if (trend === 'better') {
                riskDiv.className = 'existential-risk good-news';
                riskText.innerHTML = `
                    <strong>✅ LOWER EXISTENTIAL RISK</strong><br>
                    ${safePercent}% chance the Great Filter is behind humanity<br>
                    ${riskPercent}% chance it's ahead of us
                `;
            } else {
                riskDiv.className = 'existential-risk';
                riskText.innerHTML = `
                    ${safePercent}% behind / ${riskPercent}% ahead
                `;
            }
        }

        //-------------------------------------------------------------------------------
        function hideEvidenceInfo() {
            document.getElementById('evidenceInfo').style.display = 'none';
        }

        //-------------------------------------------------------------------------------
        function resetModel() {
            currentSurvivalProbs = [...priorSurvivalProbs];
            currentFilterLocationProbs = [...priorFilterLocationProbs];

            const humanityStep = parseInt(document.getElementById('humanityStep').value) - 1;
            let probAhead = 0;
            for (let i = 0; i < numSteps; i++) {
                if (i > humanityStep) probAhead += currentFilterLocationProbs[i];
            }
            baselineProbAhead = probAhead;

            updateAllCharts();
            updateTable();
            updateRiskAssessment();
            hideEvidenceInfo();
        }

        //-------------------------------------------------------------------------------
        function updateAllCharts() {
            updateSurvivalChart();
            updateFilterLocationChart();
            updateCumulativeChart();
        }

        //-------------------------------------------------------------------------------
        function updateSurvivalChart() {
            if (survivalChart) {
                survivalChart.destroy();
            }

            // Correct labels to use stepNames directly
            const labels = stepNames.slice(0, numSteps);

            const ctx = document.getElementById('survivalChart').getContext('2d');

            survivalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Current',
                        data: currentSurvivalProbs.map(x => (x * 100).toFixed(2)),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    }, {
                        label: 'Prior',
                        data: priorSurvivalProbs.map(x => (x * 100).toFixed(2)),
                        backgroundColor: 'rgba(255, 99, 132, 0.3)',
                        borderColor: 'rgba(255, 99, 132, 0.8)',
                        borderWidth: 1,
                        type: 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Step Survival Probabilities',
                            font: { size: 14, weight: 'bold' }
                        },
                        legend: { display: true }
                    },
                    scales: {
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 90,
                                minRotation: 0,
                                callback: function(value, index, ticks) {
                                    // Return the step number (horizontal) and the step name (rotated)
                                    return stepNames[index]+ ':\n' + (index + 1);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Evolutionary Step'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Survival Probability (%)'
                            }
                        }
                    }
                }
            });
        }

        //-------------------------------------------------------------------------------
        function updateFilterLocationChart() {
            if (filterLocationChart) {
                filterLocationChart.destroy();
            }

            const ctx = document.getElementById('filterLocationChart').getContext('2d');
            const labels = Array.from({length: numSteps}, (_, i) => `${i + 1}`);

            filterLocationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Current Filter Location',
                        data: currentFilterLocationProbs.map(x => (x * 100).toFixed(2)),
                        backgroundColor: 'rgba(255, 107, 107, 0.8)',
                        borderColor: 'rgba(255, 107, 107, 1)',
                        borderWidth: 2
                    }, {
                        label: 'Prior Filter Location',
                        data: priorFilterLocationProbs.map(x => (x * 100).toFixed(2)),
                        backgroundColor: 'rgba(135, 206, 235, 0.3)',
                        borderColor: 'rgba(135, 206, 235, 0.8)',
                        borderWidth: 1,
                        type: 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Great Filter Location Probability',
                            font: { size: 14, weight: 'bold' }
                        },
                        legend: { display: true }
                    },
                    scales: {
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 90,
                                minRotation: 0,
                                padding: 5,             // small space above axis
                                align: 'center',
                                crossAlign: 'top',   // vertically center labels
                                callback: function(value, index, ticks) {
                                    return stepNames[index] + ':\n' + (index + 1);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Evolutionary Step'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Filter Location Probability (%)'
                            }
                        }
                    }
                }
            });
        }

        //-------------------------------------------------------------------------------
        function updateCumulativeChart() {
            if (cumulativeChart) {
                cumulativeChart.destroy();
            }

            const ctx = document.getElementById('cumulativeChart').getContext('2d');
            const labels = Array.from({length: numSteps}, (_, i) => `${i + 1}`);
            
            const currentCumulative = calculateCumulativeProbabilities(currentSurvivalProbs);
            const priorCumulative = calculateCumulativeProbabilities(priorSurvivalProbs);
            
            // Combine and find the minimum value. Filter out any non-positive values.
            const allData = [...currentCumulative, ...priorCumulative].filter(val => val > 0);
            const lowestValue = Math.min(...allData);

            // Set the dynamic minimum for the y-axis.
            // Multiplying by 0.1 provides a little space below the lowest data point.
            const yAxisMin = lowestValue * 0.1;

            cumulativeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Current Cumulative',
                        data: currentCumulative,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 3,
                        fill: true
                    }, {
                        label: 'Prior Cumulative',
                        data: priorCumulative,
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cumulative Reach Probability',
                            font: { size: 14, weight: 'bold' }
                        },
                        legend: { display: true }
                    },
                    scales: {
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 90,
                                minRotation: 0,
                                callback: function(value, index, ticks) {
                                    // Return the step number (horizontal) and the step name (rotated)
                                    return stepNames[index]+ ':\n' + (index + 1);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Evolutionary Step'
                            }
                        },
                        y: {
                            type: 'logarithmic',
                            min: yAxisMin, // Use the dynamically calculated minimum
                            max: 1,
                            title: {
                                display: true,
                                text: 'Cumulative Probability - Log Scale'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    // Format in scientific notation
                                    if (value >= 0.01) {
                                        return (value * 100).toFixed(2) + '%';
                                    } else {
                                        return value.toExponential(1);
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        //-------------------------------------------------------------------------------
        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            const cumulative = calculateCumulativeProbabilities(currentSurvivalProbs);
            
            for(let i = 0; i < numSteps; i++) {
                const row = tableBody.insertRow();
                const difficulty = 1 - currentSurvivalProbs[i];
                
                row.insertCell(0).textContent = i + 1;
                row.insertCell(1).textContent = stepNames[i];
                row.insertCell(2).textContent = (currentSurvivalProbs[i] * 100).toFixed(2) + '%';
                row.insertCell(3).textContent = (currentFilterLocationProbs[i] * 100).toFixed(2) + '%';
                
                // Format cumulative probability with scientific notation for very small values
                const cumulativeCell = row.insertCell(4);
                if (cumulative[i] >= 0.0001) {
                    cumulativeCell.textContent = (cumulative[i] * 100).toFixed(4) + '%';
                } else {
                    cumulativeCell.textContent = cumulative[i].toExponential(2);
                }
                
                row.insertCell(5).textContent = (difficulty * 100).toFixed(2) + '%';
                
                if(currentFilterLocationProbs[i] > 0.15) {
                    row.style.backgroundColor = 'rgba(255, 230, 230, 0.8)';
                }
            }
        }

        //-------------------------------------------------------------------------------
        // Initialize on page load
        window.onload = function() {
            // Update initial slider values for display
            document.getElementById('baseProbValue').textContent = "10.0%";
            document.getElementById('updateValuePrior').textContent = "2.0x";
            document.getElementById('updateValueNext').textContent = "3.0x";
            document.getElementById('updateValueFirst').textContent = "1.5x";
            
            // Toggle controls and initialize the model as before
            toggleExtinctControls();
            initializeModel();
        };
    </script>
</body>
</html>